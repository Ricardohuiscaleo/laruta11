---
// Game page for La Ruta 11 Foodtrucks - Versi√≥n Mejorada
---

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>üöö La Ruta 11 Foodtrucks Game</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#708c5d">
    <style>
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background: linear-gradient(135deg, #1a1a1a 0%, #2c3e50 100%);
            color: #fff;
            font-family: 'Press Start 2P', cursive;
            margin: 0;
            padding: 0;
            overflow: hidden;
            position: fixed;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        body.fullscreen {
            background: #000;
        }
        
        #gameContainer {
            position: relative;
            background: linear-gradient(180deg, #87CEEB 0%, #708c5d 30%, #5a7c47 100%);
            border-radius: 15px;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.8);
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            #gameContainer {
                width: 100vw;
                height: 100vh;
                border-radius: 0;
            }
            
            #modal {
                padding: 15px;
                gap: 15px;
            }
            
            .story-content {
                max-height: 60vh;
                overflow-y: auto;
            }
            
            .game-button {
                min-height: 60px;
                font-size: 0.7rem;
                padding: 15px 25px;
                width: 100%;
                max-width: 280px;
            }
            
            .animated-title {
                font-size: 1rem;
                margin-bottom: 10px;
            }
            
            .subtitle {
                font-size: 0.7rem;
            }
            
            .reward-title, .challenge-title {
                font-size: 0.6rem;
            }
            
            .reward-text {
                font-size: 0.8rem;
            }
        }
        
        @media (min-width: 769px) {
            #gameContainer {
                width: min(90vw, 450px);
                height: min(90vh, 800px);
                max-width: 450px;
                max-height: 800px;
            }
        }
        
        /* Fullscreen Mode */
        .fullscreen #gameContainer {
            width: 100vw;
            height: 100vh;
            border-radius: 0;
        }
        
        canvas {
            display: block;
            width: 100%;
            height: 100%;
            background-color: transparent;
            transition: transform 0.1s;
        }
        
        #uiOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: clamp(10px, 3vw, 20px);
            pointer-events: none;
            z-index: 5;
        }
        
        #top-ui {
            display: flex;
            flex-direction: column;
            gap: clamp(8px, 2vw, 15px);
        }
        
        #stats-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: clamp(0.6rem, 2.5vw, 1rem);
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            background: rgba(0,0,0,0.7);
            padding: clamp(10px, 3vw, 15px);
            border-radius: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        #consolidated-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: clamp(0.5rem, 2vw, 0.8rem);
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            background: rgba(0,0,0,0.6);
            padding: clamp(8px, 2vw, 12px);
            border-radius: 10px;
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255,255,255,0.15);
        }
        
        #prizes-section {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        #prizes-section h4 {
            margin: 0;
            font-size: 0.9em;
            color: #ffc107;
        }
        
        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .stat-icon {
            font-size: 1.2em;
        }
        
        #health-bar-container {
            height: clamp(15px, 4vw, 25px);
            background: rgba(0,0,0,0.6);
            border: 2px solid #fff;
            border-radius: 15px;
            padding: 3px;
            backdrop-filter: blur(5px);
        }
        
        #health-bar {
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, #ff4757 0%, #ffc107 50%, #2ecc71 100%);
            border-radius: 12px;
            transition: width 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 0 0 10px rgba(46, 204, 113, 0.5);
        }
        
        #health-bar.low {
            animation: pulse-red 1s infinite;
        }
        
        @keyframes pulse-red {
            0%, 100% { box-shadow: 0 0 10px rgba(255, 71, 87, 0.8); }
            50% { box-shadow: 0 0 20px rgba(255, 71, 87, 1); }
        }
        

        
        #prizes-list {
            margin: 0;
            padding: 0;
            list-style: none;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        
        .prize-item {
            background: linear-gradient(45deg, #f1c40f, #e67e22);
            color: #000;
            padding: 3px 8px;
            border-radius: 15px;
            font-size: 0.6em;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            white-space: nowrap;
        }
        
        #modal {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: clamp(10px, 3vw, 20px);
            padding: clamp(10px, 3vw, 20px);
            z-index: 100;
            transition: all 0.3s ease;
            backdrop-filter: blur(15px);
            overflow-y: auto;
            box-sizing: border-box;
        }
        
        #modal:not(.hidden) ~ canvas {
            filter: blur(8px) brightness(0.3);
            transition: filter 0.3s ease;
        }
        
        #modal.hidden {
            opacity: 0;
            pointer-events: none;
            transform: scale(0.9);
        }
        
        #modal h2 {
            margin: 0;
            font-size: clamp(0.8rem, 3vw, 1.5rem);
            color: #ffc107;
            text-align: center;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            line-height: 1.2;
        }
        
        #modal p {
            margin: 0;
            font-size: clamp(0.5rem, 2vw, 0.8rem);
            line-height: 1.4;
            text-align: center;
            max-width: 95%;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .game-button {
            padding: clamp(12px, 4vw, 18px) clamp(24px, 6vw, 36px);
            font-size: clamp(0.6rem, 2.2vw, 0.9rem);
            font-family: 'Press Start 2P', cursive;
            color: #fff;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            text-transform: uppercase;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            position: relative;
            overflow: hidden;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .game-button:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .game-button:hover:before {
            left: 100%;
        }
        
        #startButton {
            background: linear-gradient(45deg, #2ecc71, #27ae60);
        }
        
        #fullscreenButton {
            background: linear-gradient(45deg, #3498db, #2980b9);
        }
        
        #homeButton {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }
        
        .game-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.6);
        }
        
        .game-button:active {
            transform: translateY(-1px);
        }
        
        #controls-info {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            padding: 10px 20px;
            border-radius: 20px;
            font-size: clamp(0.5rem, 2vw, 0.7rem);
            text-align: center;
            backdrop-filter: blur(5px);
            pointer-events: all;
        }
        
        #alert-message {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translateX(-50%);
            font-size: clamp(0.8rem, 3vw, 1.2rem);
            color: #ff4757;
            background: rgba(0,0,0,0.9);
            padding: clamp(10px, 3vw, 20px);
            border-radius: 15px;
            border: 2px solid #ff4757;
            text-shadow: 2px 2px 4px #000;
            z-index: 50;
            text-align: center;
            opacity: 0;
            transition: all 0.5s ease;
            backdrop-filter: blur(10px);
            max-width: 90%;
        }
        
        .alert-visible {
            opacity: 1;
            animation: alert-pulse 1.5s infinite;
        }
        
        @keyframes alert-pulse {
            0%, 100% { 
                transform: translateX(-50%) scale(1);
                border-color: #ff4757;
            }
            50% { 
                transform: translateX(-50%) scale(1.05);
                border-color: #ff6b7a;
                box-shadow: 0 0 20px rgba(255, 71, 87, 0.5);
            }
        }
        
        /* Touch Controls */
        #touch-controls {
            position: absolute;
            bottom: 80px;
            left: 0;
            right: 0;
            display: none;
            justify-content: space-between;
            padding: 0 40px;
            pointer-events: all;
        }
        
        @media (max-width: 768px) {
            #touch-controls {
                display: flex;
            }
            #controls-info {
                display: none;
            }
        }
        
        .touch-button {
            width: 75px;
            height: 75px;
            background: linear-gradient(145deg, rgba(255,255,255,0.25), rgba(255,255,255,0.1));
            border: 3px solid rgba(255,255,255,0.6);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.15s ease;
            backdrop-filter: blur(15px);
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.4);
            position: relative;
        }
        
        .triangle-left {
            width: 0;
            height: 0;
            border-top: 15px solid transparent;
            border-bottom: 15px solid transparent;
            border-right: 20px solid #fff;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.8));
        }
        
        .triangle-right {
            width: 0;
            height: 0;
            border-top: 15px solid transparent;
            border-bottom: 15px solid transparent;
            border-left: 20px solid #fff;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.8));
        }
        
        .touch-button::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            right: 2px;
            bottom: 2px;
            border-radius: 50%;
            background: linear-gradient(145deg, rgba(255,255,255,0.1), transparent);
            pointer-events: none;
        }
        
        .touch-button:active,
        .touch-button:hover {
            background: linear-gradient(145deg, rgba(255,255,255,0.4), rgba(255,255,255,0.2));
            transform: scale(0.92);
            border-color: rgba(255,255,255,0.9);
            box-shadow: 0 2px 8px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.6);
        }
        
        @media (max-width: 480px) {
            .touch-button {
                width: 85px;
                height: 85px;
            }
            
            .triangle-left {
                border-top: 18px solid transparent;
                border-bottom: 18px solid transparent;
                border-right: 24px solid #fff;
            }
            
            .triangle-right {
                border-top: 18px solid transparent;
                border-bottom: 18px solid transparent;
                border-left: 24px solid #fff;
            }
            
            #touch-controls {
                padding: 0 30px;
                bottom: 100px;
            }
            
            #modal {
                padding: 10px;
                gap: 10px;
            }
            
            .game-button {
                min-height: 55px;
                font-size: 0.6rem;
                padding: 12px 20px;
            }
            
            .story-content {
                max-height: 50vh;
            }
            
            .animated-title {
                font-size: 0.9rem;
            }
        }
        
        /* Loading Screen */
        #loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a1a, #2c3e50);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 200;
            transition: opacity 0.5s ease;
        }
        
        #loading.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid #ffc107;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Story and Animation Styles */
        .story-header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .animated-title {
            background: linear-gradient(45deg, #ff6b35, #f7931e, #ffc107, #ff6b35);
            background-size: 400% 400%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradientShift 3s ease-in-out infinite;
            margin: 0;
            font-size: clamp(1.2rem, 4vw, 1.8rem);
        }
        
        .subtitle {
            color: #e74c3c;
            font-size: clamp(0.8rem, 2.5vw, 1rem);
            font-weight: bold;
            animation: pulse 2s infinite;
        }
        
        .story-content {
            text-align: left;
            margin: 20px 0;
            width: 100%;
            

        }
        
        .mission-text {
            background: rgba(0,0,0,0.8);
            padding: clamp(15px, 4vw, 25px);
            border-radius: 10px;
            border: 2px solid #ffc107;
            margin: 10px auto;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            display: block;
            text-align: center;
            font-size: clamp(0.5rem, 2vw, 0.8rem);
            line-height: 1.3;
        }
        
        .highlight-orange {
            color: #ff6b35;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(255, 107, 53, 0.5);
        }
        
        .highlight-green {
            color: #2ecc71;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(46, 204, 113, 0.5);
        }
        
        .highlight-red {
            color: #e74c3c;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(231, 76, 60, 0.5);
        }
        
        .pulsing {
            animation: pulse 1.5s infinite;
        }
        
        .challenge-box {
            background: rgba(231, 76, 60, 0.1);
            border: 2px solid #e74c3c;
            border-radius: 10px;
            padding: clamp(10px, 3vw, 15px);
            margin: 10px 0;
            width: 100%;
            box-sizing: border-box;
        }
        
        .challenge-title {
            color: #e74c3c;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .challenge-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .challenge-list li {
            padding: 3px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            font-size: clamp(0.5rem, 1.8vw, 0.7rem);
        }
        
        .reward-section {
            background: linear-gradient(45deg, rgba(46, 204, 113, 0.2), rgba(52, 152, 219, 0.2));
            border: 2px solid #2ecc71;
            border-radius: 10px;
            padding: clamp(10px, 3vw, 15px);
            text-align: center;
            margin: 10px 0;
            width: 100%;
            box-sizing: border-box;
        }
        
        .reward-title {
            color: #fff;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .reward-text {
            color: #f1c40f;
            font-size: 1.1em;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(241, 196, 15, 0.5);
        }
        
        .start-mission {
            background: linear-gradient(45deg, #e74c3c, #c0392b) !important;
            animation: buttonPulse 2s infinite;
        }
        
        .prize-success {
            color: #2ecc71;
            font-weight: bold;
            animation: celebration 2s infinite;
        }
        
        .no-prize {
            color: #e74c3c;
        }
        
        .result-summary {
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #ffc107;
        }
        
        .ticket-count {
            color: #f1c40f;
            font-weight: bold;
            font-size: 1.2em;
        }
        
        .success-msg {
            color: #2ecc71;
            font-weight: bold;
        }
        
        .fail-msg {
            color: #e74c3c;
            font-weight: bold;
        }
        
        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }
        
        @keyframes buttonPulse {
            0%, 100% { transform: scale(1); box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4); }
            50% { transform: scale(1.05); box-shadow: 0 8px 25px rgba(231, 76, 60, 0.8); }
        }
        
        @keyframes celebration {
            0%, 100% { transform: scale(1); }
            25% { transform: scale(1.1) rotate(5deg); }
            75% { transform: scale(1.1) rotate(-5deg); }
        }
        
        /* Crash Message Styles */
        .crash-title {
            color: #e74c3c;
            animation: flashRed 2s infinite;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .crash-story {
            text-align: center;
            line-height: 1.8;
            max-width: 90%;
            margin: 0 auto;
        }
        
        .crash-text {
            background: rgba(231, 76, 60, 0.1);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #e74c3c;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .truck-status {
            background: rgba(46, 204, 113, 0.1);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #2ecc71;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .driver-mystery {
            background: rgba(52, 152, 219, 0.1);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #3498db;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .mystery-text {
            color: #9b59b6;
            font-style: italic;
            animation: fadeInOut 3s infinite;
        }
        
        .wobble {
            animation: wobble 2s infinite;
        }
        
        .bounce {
            animation: bounce 2s infinite;
        }
        
        .shake {
            animation: shake 2s infinite;
        }
        
        .highlight-blue {
            color: #3498db;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(52, 152, 219, 0.5);
        }
        
        @keyframes flashRed {
            0%, 100% { color: #e74c3c; }
            50% { color: #ff6b7a; text-shadow: 0 0 20px rgba(231, 76, 60, 0.8); }
        }
        
        @keyframes wobble {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-3deg); }
            75% { transform: rotate(3deg); }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        @keyframes fadeInOut {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; transform: scale(1.05); }
        }
        
        /* Additional Color Highlights */
        .highlight-white {
            color: #ffffff;
            font-weight: bold;
        }
        
        .highlight-yellow {
            color: #f1c40f;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(241, 196, 15, 0.5);
        }
        
        .highlight-cyan {
            color: #1abc9c;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(26, 188, 156, 0.5);
        }
        
        /* Restart Button Styling */
        .restart-button {
            background: linear-gradient(45deg, #e67e22, #d35400) !important;
            animation: restartPulse 2s infinite;
        }
        
        @keyframes restartPulse {
            0%, 100% { 
                transform: scale(1); 
                box-shadow: 0 4px 15px rgba(230, 126, 34, 0.4);
            }
            50% { 
                transform: scale(1.05); 
                box-shadow: 0 8px 25px rgba(230, 126, 34, 0.8);
            }
        }
        
        /* Game Over Specific Animations */
        @keyframes flashRed {
            0%, 100% { color: #e74c3c; text-shadow: 0 0 10px rgba(231, 76, 60, 0.5); }
            50% { color: #ff4757; text-shadow: 0 0 20px rgba(255, 71, 87, 1); }
        }
        
        @keyframes wobbleText {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-2deg); }
            75% { transform: rotate(2deg); }
        }
        
        @keyframes bounceText {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-8px); }
            60% { transform: translateY(-4px); }
        }
        
        @keyframes pulseGreen {
            0%, 100% { transform: scale(1); color: #2ecc71; }
            50% { transform: scale(1.05); color: #27ae60; }
        }
        
        @keyframes fadeInOut {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; transform: scale(1.02); }
        }
        
        @keyframes shakeText {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-3px); }
            75% { transform: translateX(3px); }
        }
        
        @keyframes buttonGlow {
            0%, 100% { 
                box-shadow: 0 4px 15px rgba(230, 126, 34, 0.4);
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 8px 30px rgba(230, 126, 34, 0.8), 0 0 20px rgba(255, 165, 0, 0.6);
                transform: scale(1.02);
            }
        }
    </style>
</head>
<body>

    <div id="gameContainer">
        <!-- Loading Screen -->
        <div id="loading">
            <div class="loading-spinner"></div>
            <p>üöö Cargando La Ruta 11...</p>
        </div>
        
        <!-- Game Canvas -->
        <canvas id="gameCanvas"></canvas>
        
        <!-- Alert Messages -->
        <div id="alert-message"></div>
        
        <!-- Game UI Overlay -->
        <div id="uiOverlay">
            <div id="top-ui">
                <div id="stats-bar">
                    <div class="stat-item">
                        <span class="stat-icon">‚è±Ô∏è</span>
                        <span id="timer">111</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-icon">üé´</span>
                        <span id="score">0</span>
                    </div>
                </div>
                <div id="health-bar-container">
                    <div id="health-bar"></div>
                </div>
                <div id="consolidated-info">
                    <div id="prizes-section">
                        <h4>üèÜ Premios:</h4>
                        <ul id="prizes-list"></ul>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Touch Controls for Mobile -->
        <div id="touch-controls">
            <div class="touch-button" id="leftButton">
                <div class="triangle-left"></div>
            </div>
            <div class="touch-button" id="rightButton">
                <div class="triangle-right"></div>
            </div>
        </div>
        
        <!-- Controls Info -->
        <div id="controls-info">
            üéÆ Usa ‚Üê ‚Üí o A/D para moverte
        </div>
        
        <!-- Game Modal -->
        <div id="modal">
            <div class="story-header">
                <h2 class="animated-title">üöö EL CHOFER LOCO DE LA RUTA 11</h2>
                <div class="subtitle">¬°NECESITA TU AYUDA!</div>
            </div>
            
            <div class="story-content">
                <div class="reward-section">
                    <div class="reward-title">Ayuda al <span class="highlight-orange">CHOFER LOCO</span> a llegar a tiempo a <span class="highlight-green">POCONCHILE en 111 segundos...</span>. S√≠, en <span class="highlight-red pulsing">111 SEGUNDOS</span>!</div>
                    <div class="reward-text">üéÜ ¬°√âL TE RECOMPENSAR√Å! CON JUGOSOS DESCUENTOS!!!</div>
                </div>
                
                <div class="challenge-box">
                    <div class="challenge-title">‚ö†Ô∏è SOBREVIVE EN LA RUTA:</div>
                    <ul class="challenge-list">
                        <li>üöõ Esquiva camiones locos</li>
                        <li>ü¶ô Cuidado con animales cruzando</li>
                        <li>üèÜ Recoge tickets en el camino</li>
                    </ul>
                </div>
            </div>
            
            <div class="button-group">
                <button id="startButton" class="game-button start-mission">üöÄ ¬°INICIAR MISI√ìN!</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURACI√ìN INICIAL ---
        const canvas = document.getElementById('gameCanvas') as HTMLCanvasElement;
        const ctx = canvas?.getContext('2d');
        const container = document.getElementById('gameContainer');
        const loading = document.getElementById('loading');
        
        if (!canvas || !ctx || !container) {
            console.error('Required elements not found');
        }
        
        // Game state management
        let isFullscreen = false;
        let isMobile = window.innerWidth <= 768;
        
        // Responsive canvas setup
        function resizeCanvas() {
            if (!canvas || !container) return;
            const rect = container.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = rect.height;
            
            // Update game objects positions
            if (typeof truck !== 'undefined') {
                truck.x = canvas.width / 2 - truck.width / 2;
                truck.y = canvas.height - 240;
                trailer.x = truck.x + (truck.width - trailer.width) / 2;
                trailer.y = truck.y + truck.height;
            }
        }
        
        // --- OBJETOS DEL JUEGO ---
        const truck = { 
            width: isMobile ? 40 : 50, 
            height: isMobile ? 60 : 70, 
            y: canvas?.height ? canvas.height - 240 : 480, 
            color: '#3498db',
            x: canvas?.width ? canvas.width / 2 - (isMobile ? 40 : 50) / 2 : 200
        };
        const trailer = { 
            width: isMobile ? 45 : 55, 
            height: isMobile ? 90 : 110, 
            color: '#e74c3c',
            x: truck.x + (truck.width - (isMobile ? 45 : 55)) / 2,
            y: truck.y + truck.height
        };
        
        // Initialize canvas
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        const timerEl = document.getElementById('timer');
        const scoreEl = document.getElementById('score');
        const prizesEl = document.getElementById('prizes-list');
        const modal = document.getElementById('modal');

        const startButton = document.getElementById('startButton');
        const alertEl = document.getElementById('alert-message');
        const healthBar = document.getElementById('health-bar');
        const leftButton = document.getElementById('leftButton');
        const rightButton = document.getElementById('rightButton');

        // --- VARIABLES DEL JUEGO ---
        let gameState = 'loading';
        let frameCount = 0;
        let score = 0;
        let timeLeft = 111;
        let gameInterval;
        
        let roadSpeed = 7;
        let baseRoadSpeed = 7;
        let gameSpeedMultiplier = 1;
        let roadCurve = 0;
        let playerOffset = 0;
        let playerHealth = 100;
        let shakeTime = 0;
        let lastMoveTime = 0;
        let animalCrossingEvent = false;
        let animalSpawned = { at10: false, at40: false, at60: false };

        let roadElements: any[] = [];
        let playerPrizes = { discount: 0 };
        
        // Performance optimization
        let lastFrameTime = 0;
        const targetFPS = 60;
        const frameInterval = 1000 / targetFPS;
        
        // Game stuck detection
        let lastFrameCount = 0;
        let stuckCheckTime = Date.now();
        let gameStuckTimeout: number;



        // --- SPRITE SYSTEM ---
        const sprites = {
            playerTruck: new Image(),
            playerTrailer: new Image(),
            enemyTruck1: new Image(),
            enemyTruck2: new Image(),
            ticket: new Image()
        };
        
        let spritesLoaded = 0;
        const totalSprites = Object.keys(sprites).length;
        
        // Load sprites
        sprites.playerTruck.src = '/vehicles/truck-player.png';
        sprites.playerTrailer.src = '/vehicles/trailer-player.png';
        sprites.enemyTruck1.src = '/vehicles/truck-enemy1.png';
        sprites.enemyTruck2.src = '/vehicles/truck-enemy2.png';
        sprites.ticket.src = '/vehicles/ticket.png';
        
        // Track sprite loading
        Object.values(sprites).forEach(img => {
            img.onload = () => {
                spritesLoaded++;
                if (spritesLoaded === totalSprites) {
                    console.log('All sprites loaded');
                }
            };
            img.onerror = () => {
                spritesLoaded++; // Continue even if sprite fails
            };
        });
        
        // --- AUDIO SYSTEM ---
        let sfxSynth: any = null;
        let backgroundMusic: HTMLAudioElement | null = null;
        let ambientSound: HTMLAudioElement | null = null;
        let audioInitialized = false;
        
        function initAudio() {
            if (!audioInitialized) {
                try {
                    // Initialize Tone.js for sound effects
                    if (typeof (window as any).Tone !== 'undefined') {
                        const Tone = (window as any).Tone;
                        sfxSynth = new Tone.Synth({
                            oscillator: { type: 'square' },
                            envelope: { attack: 0.1, decay: 0.2, sustain: 0.3, release: 0.4 }
                        }).toDestination();
                        if (sfxSynth) sfxSynth.volume.value = -10;
                    }
                    
                    // Initialize background music
                    backgroundMusic = new Audio('/music-game/sandworm_loop.wav');
                    backgroundMusic.loop = true;
                    backgroundMusic.volume = 0;
                    
                    // Initialize ambient road sound
                    ambientSound = new Audio('/music-game/carretera.mp3');
                    ambientSound.loop = true;
                    ambientSound.volume = 0;
                    
                    audioInitialized = true;
                } catch (error) {
                    console.warn('Audio initialization failed:', error);
                }
            }
        }
        
        function startBackgroundMusic() {
            // Start background music at 50%
            if (backgroundMusic) {
                backgroundMusic.currentTime = 0;
                backgroundMusic.play().then(() => {
                    let musicVolume = 0;
                    const musicFadeIn = setInterval(() => {
                        musicVolume += 0.02;
                        if (musicVolume >= 0.5) {
                            musicVolume = 0.5;
                            clearInterval(musicFadeIn);
                        }
                        if (backgroundMusic) backgroundMusic.volume = musicVolume;
                    }, 50);
                }).catch(err => console.warn('Music play failed:', err));
            }
            
            // Start ambient road sound at 30%
            if (ambientSound) {
                ambientSound.currentTime = 0;
                ambientSound.play().then(() => {
                    let ambientVolume = 0;
                    const ambientFadeIn = setInterval(() => {
                        ambientVolume += 0.015;
                        if (ambientVolume >= 0.3) {
                            ambientVolume = 0.3;
                            clearInterval(ambientFadeIn);
                        }
                        if (ambientSound) ambientSound.volume = ambientVolume;
                    }, 50);
                }).catch(err => console.warn('Ambient sound play failed:', err));
            }
        }
        
        function stopBackgroundMusic() {
            // Fade out background music
            if (backgroundMusic) {
                let musicVolume = backgroundMusic.volume;
                const musicFadeOut = setInterval(() => {
                    musicVolume -= 0.05;
                    if (musicVolume <= 0) {
                        musicVolume = 0;
                        clearInterval(musicFadeOut);
                        if (backgroundMusic) backgroundMusic.pause();
                    }
                    if (backgroundMusic) backgroundMusic.volume = musicVolume;
                }, 50);
            }
            
            // Fade out ambient sound
            if (ambientSound) {
                let ambientVolume = ambientSound.volume;
                const ambientFadeOut = setInterval(() => {
                    ambientVolume -= 0.03;
                    if (ambientVolume <= 0) {
                        ambientVolume = 0;
                        clearInterval(ambientFadeOut);
                        if (ambientSound) ambientSound.pause();
                    }
                    if (ambientSound) ambientSound.volume = ambientVolume;
                }, 50);
            }
        }
        
        // Initialize loading sequence with progress
        let loadingProgress = 0;
        const loadingInterval = setInterval(() => {
            loadingProgress += Math.random() * 30;
            if (loadingProgress >= 100) {
                loadingProgress = 100;
                clearInterval(loadingInterval);
                setTimeout(() => {
                    initAudio();
                    loading?.classList.add('hidden');
                    gameState = 'menu';
                }, 500);
            }
        }, 200);
        
        // Show loading progress
        const loadingText = loading?.querySelector('p');
        const progressInterval = setInterval(() => {
            if (loadingProgress >= 100) {
                clearInterval(progressInterval);
                if (loadingText) loadingText.textContent = 'üéÜ ¬°Listo para jugar!';
            } else {
                if (loadingText) loadingText.textContent = `üöö Cargando La Ruta 11... ${Math.floor(loadingProgress)}%`;
            }
        }, 100);

        // --- FUNCIONES DE DIBUJO MEJORADAS ---
        function drawPlayer() {
            if (!canvas || !ctx) return;
            const currentTruckX = canvas.width / 2 - truck.width / 2 + playerOffset;
            const targetTrailerX = currentTruckX + (truck.width - trailer.width) / 2;
            
            // Smooth trailer movement
            trailer.x += (targetTrailerX - trailer.x) * 0.15;
            trailer.y = truck.y + truck.height + 5;
            
            // Draw trailer with improved graphics
            drawTrailer(trailer.x, trailer.y);
            
            // Draw truck with improved graphics
            drawTruck(currentTruckX, truck.y);
            
            truck.x = currentTruckX;
        }
        
        function drawTruck(x: number, y: number) {
            if (!ctx) return;
            
            // Try to use sprite first, fallback to drawn graphics
            if (sprites.playerTruck.complete && sprites.playerTruck.naturalWidth > 0) {
                // Shadow
                ctx.globalAlpha = 0.3;
                ctx.fillStyle = '#000';
                ctx.fillRect(x + 2, y + 2, truck.width, truck.height);
                ctx.globalAlpha = 1;
                
                // Draw sprite
                ctx.drawImage(sprites.playerTruck, x, y, truck.width, truck.height);
            } else {
                // Fallback to original drawn graphics
                ctx.fillStyle = 'rgba(0,0,0,0.3)';
                ctx.fillRect(x + 2, y + 2, truck.width, truck.height);
                
                const gradient = ctx.createLinearGradient(x, y, x + truck.width, y + truck.height);
                gradient.addColorStop(0, '#4a90e2');
                gradient.addColorStop(0.5, truck.color);
                gradient.addColorStop(1, '#2c5aa0');
                ctx.fillStyle = gradient;
                ctx.fillRect(x, y, truck.width, truck.height);
                
                ctx.fillStyle = '#87ceeb';
                ctx.fillRect(x + 5, y + 8, truck.width - 10, truck.height * 0.4);
                
                ctx.fillStyle = 'rgba(255,255,255,0.3)';
                ctx.fillRect(x + 5, y + 8, truck.width - 10, 8);
                
                // Camioneta: sin ruedas visibles en vista cenital
                
                ctx.fillStyle = '#34495e';
                ctx.fillRect(x + truck.width / 2 - 3, y + truck.height - 8, 6, 8);
                
                ctx.fillStyle = '#f1c40f';
                ctx.fillRect(x + 2, y + truck.height / 2, 3, 6);
                ctx.fillRect(x + truck.width - 5, y + truck.height / 2, 3, 6);
            }
        }
        
        function drawTrailer(x: number, y: number) {
            if (!ctx) return;
            
            // Try to use sprite first, fallback to drawn graphics
            if (sprites.playerTrailer.complete && sprites.playerTrailer.naturalWidth > 0) {
                // Shadow
                ctx.globalAlpha = 0.3;
                ctx.fillStyle = '#000';
                ctx.fillRect(x + 2, y + 2, trailer.width, trailer.height);
                ctx.globalAlpha = 1;
                
                // Draw sprite
                ctx.drawImage(sprites.playerTrailer, x, y, trailer.width, trailer.height);
            } else {
                // Fallback to original drawn graphics
                ctx.fillStyle = 'rgba(0,0,0,0.3)';
                ctx.fillRect(x + 2, y + 2, trailer.width, trailer.height);
                
                const gradient = ctx.createLinearGradient(x, y, x + trailer.width, y + trailer.height);
                gradient.addColorStop(0, '#e67e22');
                gradient.addColorStop(0.5, trailer.color);
                gradient.addColorStop(1, '#c0392b');
                ctx.fillStyle = gradient;
                ctx.fillRect(x, y, trailer.width, trailer.height);
                
                // Trailer: eje doble al centro en los laterales (4 ruedas)
                ctx.fillStyle = '#2c3e50';
                const centerY = y + trailer.height / 2;
                // Lado izquierdo - eje doble
                ctx.fillRect(x - 2, centerY - 8, 3, 6);
                ctx.fillRect(x - 2, centerY + 2, 3, 6);
                // Lado derecho - eje doble
                ctx.fillRect(x + trailer.width - 1, centerY - 8, 3, 6);
                ctx.fillRect(x + trailer.width - 1, centerY + 2, 3, 6);
                
                ctx.fillStyle = '#95a5a6';
                // Rines lado izquierdo
                ctx.fillRect(x - 1, centerY - 7, 1, 4);
                ctx.fillRect(x - 1, centerY + 3, 1, 4);
                // Rines lado derecho
                ctx.fillRect(x + trailer.width, centerY - 7, 1, 4);
                ctx.fillRect(x + trailer.width, centerY + 3, 1, 4);
                
                ctx.fillStyle = '#34495e';
                ctx.fillRect(x + 8, y + 15, trailer.width - 16, trailer.height * 0.4);
                
                ctx.fillStyle = '#ecf0f1';
                ctx.fillRect(x + 10, y + 17, trailer.width - 20, 3);
                
                ctx.fillStyle = '#fff';
                ctx.font = `${Math.max(6, trailer.width / 12)}px "Press Start 2P"`;
                ctx.textAlign = 'center';
                ctx.fillText('RUTA', x + trailer.width / 2, y + trailer.height * 0.6);
                ctx.fillText('11', x + trailer.width / 2, y + trailer.height * 0.8);
                
                for (let i = 0; i < Math.floor(trailer.width / 8); i++) {
                    ctx.fillStyle = i % 2 === 0 ? '#f1c40f' : '#e67e22';
                    ctx.fillRect(x + (i * 8), y + 8, 8, 4);
                }
            }
        }

        function drawTicket(el: any, x: number, y: number) {
            if (!ctx) return;
            const w = el.width;
            const h = el.height;
            const time = frameCount * 0.1;
            
            // Floating animation
            const floatY = y + Math.sin(time + x * 0.01) * 3;
            
            // Ticket shadow
            ctx.fillStyle = 'rgba(0,0,0,0.3)';
            ctx.fillRect(x + 2, floatY + 2, w, h);
            
            // Ticket glow effect
            const glowGradient = ctx.createRadialGradient(x + w/2, floatY + h/2, 0, x + w/2, floatY + h/2, w);
            glowGradient.addColorStop(0, 'rgba(241, 196, 15, 0.8)');
            glowGradient.addColorStop(1, 'rgba(241, 196, 15, 0)');
            ctx.fillStyle = glowGradient;
            ctx.fillRect(x - 5, floatY - 5, w + 10, h + 10);
            
            // Main ticket body
            const gradient = ctx.createLinearGradient(x, floatY, x + w, floatY + h);
            gradient.addColorStop(0, '#f1c40f');
            gradient.addColorStop(0.5, '#f39c12');
            gradient.addColorStop(1, '#e67e22');
            ctx.fillStyle = gradient;
            ctx.fillRect(x, floatY, w, h);
            
            // Ticket border
            ctx.strokeStyle = '#d35400';
            ctx.lineWidth = 2;
            ctx.strokeRect(x, floatY, w, h);
            
            // Inner ticket design
            ctx.fillStyle = 'rgba(255,255,255,0.9)';
            ctx.fillRect(x + 4, floatY + 4, w - 8, h - 8);
            
            // Ticket symbol
            ctx.fillStyle = '#e67e22';
            ctx.font = `${Math.max(12, w/3)}px "Press Start 2P"`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('üé´', x + w / 2, floatY + h / 2);
        }

        function drawEnemyTruck(el: any, x: number, y: number) {
            if (!ctx) return;
            
            // Rotar camiones que vienen en sentido contrario
            if (el.direction === 'opposite') {
                ctx.save();
                ctx.translate(x + el.width/2, y + el.height/2);
                ctx.rotate(Math.PI);
                ctx.translate(-el.width/2, -el.height/2);
                x = 0;
                y = 0;
            }
            
            // Choose sprite based on truck type
            const sprite = el.color === '#c0392b' ? sprites.enemyTruck1 : sprites.enemyTruck2;
            
            // Try to use sprite first, fallback to drawn graphics
            if (sprite.complete && sprite.naturalWidth > 0) {
                // Shadow
                ctx.globalAlpha = 0.4;
                ctx.fillStyle = '#000';
                ctx.fillRect(x + 3, y + 3, el.width, el.height);
                ctx.globalAlpha = 1;
                
                // Draw sprite
                ctx.drawImage(sprite, x, y, el.width, el.height);
                
                // Damage effect if hit
                if (el.hit) {
                    ctx.fillStyle = 'rgba(255, 0, 0, 0.5)';
                    ctx.fillRect(x, y, el.width, el.height);
                    
                    for (let i = 0; i < 5; i++) {
                        ctx.fillStyle = '#f1c40f';
                        const sparkX = x + Math.random() * el.width;
                        const sparkY = y + Math.random() * el.height;
                        ctx.fillRect(sparkX, sparkY, 2, 2);
                    }
                }
            } else {
                // Fallback to original drawn graphics
                ctx.fillStyle = 'rgba(0,0,0,0.4)';
                ctx.fillRect(x + 3, y + 3, el.width, el.height);
                
                const gradient = ctx.createLinearGradient(x, y, x + el.width, y + el.height);
                if (el.color === '#c0392b') {
                    gradient.addColorStop(0, '#e74c3c');
                    gradient.addColorStop(0.5, el.color);
                    gradient.addColorStop(1, '#a93226');
                } else {
                    gradient.addColorStop(0, '#3498db');
                    gradient.addColorStop(0.5, el.color);
                    gradient.addColorStop(1, '#2471a3');
                }
                ctx.fillStyle = gradient;
                ctx.fillRect(x, y, el.width, el.height);
                
                ctx.fillStyle = '#34495e';
                ctx.fillRect(x, y, el.width, el.height * 0.35);
                
                ctx.fillStyle = '#5d6d7e';
                ctx.fillRect(x + 3, y + 3, el.width - 6, el.height * 0.2);
                
                // Camiones: sin ruedas visibles en vista cenital
                
                if (el.color === '#c0392b') {
                    ctx.fillStyle = '#f1c40f';
                    ctx.fillRect(x + 2, y + el.height * 0.4, 3, 4);
                    ctx.fillRect(x + el.width - 5, y + el.height * 0.4, 3, 4);
                }
                
                if (el.hit) {
                    ctx.fillStyle = 'rgba(255, 0, 0, 0.5)';
                    ctx.fillRect(x, y, el.width, el.height);
                    
                    for (let i = 0; i < 5; i++) {
                        ctx.fillStyle = '#f1c40f';
                        const sparkX = x + Math.random() * el.width;
                        const sparkY = y + Math.random() * el.height;
                        ctx.fillRect(sparkX, sparkY, 2, 2);
                    }
                }
            }
            
            if (el.direction === 'opposite') {
                ctx.restore();
            }
        }

        function drawScenery(el: any, x: number, y: number) {
            if (!ctx) return;
            if (el.type === 'guardrail') {
                // Guardrail with metallic effect
                const gradient = ctx.createLinearGradient(x, y, x + el.width, y + el.height);
                gradient.addColorStop(0, '#ecf0f1');
                gradient.addColorStop(0.5, el.color);
                gradient.addColorStop(1, '#bdc3c7');
                ctx.fillStyle = gradient;
                ctx.fillRect(x, y, el.width, el.height);
                
                // Guardrail posts
                ctx.fillStyle = '#95a5a6';
                for (let i = 0; i < el.height; i += 15) {
                    ctx.fillRect(x, y + i, el.width, 3);
                }
            }
            else if (el.variant === 'rock') {
                // Rock with texture
                ctx.fillStyle = el.color;
                ctx.beginPath();
                ctx.moveTo(x, y + el.height);
                ctx.lineTo(x + el.width * 0.3, y + el.height * 0.2);
                ctx.lineTo(x + el.width * 0.7, y);
                ctx.lineTo(x + el.width, y + el.height * 0.6);
                ctx.lineTo(x + el.width * 0.8, y + el.height);
                ctx.closePath();
                ctx.fill();
                
                // Rock highlights
                ctx.fillStyle = 'rgba(255,255,255,0.3)';
                ctx.beginPath();
                ctx.moveTo(x + el.width * 0.2, y + el.height * 0.7);
                ctx.lineTo(x + el.width * 0.4, y + el.height * 0.3);
                ctx.lineTo(x + el.width * 0.6, y + el.height * 0.5);
                ctx.closePath();
                ctx.fill();
            } else {
                // Cactus with more detail
                ctx.fillStyle = el.color;
                // Main trunk
                ctx.fillRect(x + el.width / 2 - 6, y, 12, el.height);
                
                // Cactus arms
                if (el.height > 30) {
                    ctx.fillRect(x, y + el.height * 0.4, el.width * 0.4, 8);
                    ctx.fillRect(x + el.width * 0.6, y + el.height * 0.6, el.width * 0.4, 8);
                    ctx.fillRect(x + 2, y + el.height * 0.4, 8, el.height * 0.3);
                    ctx.fillRect(x + el.width - 10, y + el.height * 0.6, 8, el.height * 0.2);
                }
                
                // Cactus spines
                ctx.fillStyle = '#2c3e50';
                for (let i = 0; i < el.height; i += 8) {
                    ctx.fillRect(x + el.width / 2 - 1, y + i, 2, 3);
                    ctx.fillRect(x + el.width / 2 + 4, y + i + 4, 2, 3);
                    ctx.fillRect(x + el.width / 2 - 6, y + i + 2, 2, 3);
                }
            }
        }
        
        function drawAnimal(el: any, x: number, y: number) {
            if (!ctx) return;
            
            // Mapear animales a emojis
            const animalEmojis: {[key: string]: string} = {
                'llama': 'ü¶ô',
                'alpaca': 'ü¶ô', 
                'huemul': 'ü¶å',
                'gato altipl√°nico': 'üêà‚Äç‚¨õ',
                'vicu√±a': 'ü¶ô',
                'chinchilla': 'üêøÔ∏è'
            };
            
            const emoji = animalEmojis[el.animalName] || 'üêæ';
            
            // Dibujar emoji grande
            ctx.font = '60px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(emoji, x + el.width/2, y + el.height/2 + 20);
            
            console.log(`üéÆ Drawing ${emoji} (${el.animalName}) at x:${x}, y:${y}`);
        }
        
        function drawChinchilla(x: number, y: number, w: number, h: number) {
            if (!ctx) return;
            // Chinchilla body (peque√±a y redonda)
            ctx.fillStyle = '#c0c0c0';
            ctx.fillRect(x + 5, y + h * 0.4, w - 10, h * 0.5);
            
            // Chinchilla head
            ctx.fillStyle = '#d3d3d3';
            ctx.fillRect(x + w * 0.25, y + 2, w * 0.5, h * 0.4);
            
            // Chinchilla ears (m√°s grandes)
            ctx.fillStyle = '#a9a9a9';
            ctx.fillRect(x + w * 0.2, y - 3, 6, 8);
            ctx.fillRect(x + w * 0.65, y - 3, 6, 8);
            
            // Chinchilla tail (m√°s visible)
            ctx.fillStyle = '#b0b0b0';
            ctx.fillRect(x + w * 0.75, y + h * 0.2, w * 0.25, h * 0.6);
            
            // Ojos
            ctx.fillStyle = '#000';
            ctx.fillRect(x + w * 0.35, y + h * 0.15, 3, 3);
            ctx.fillRect(x + w * 0.55, y + h * 0.15, 3, 3);
        }
        
        function drawAlpaca(x: number, y: number, w: number, h: number) {
            if (!ctx) return;
            // Alpaca body (similar a llama pero m√°s peque√±a)
            ctx.fillStyle = '#deb887';
            ctx.fillRect(x + 5, y + h * 0.35, w - 10, h * 0.45);
            
            // Alpaca legs (m√°s visibles)
            ctx.fillStyle = '#cd853f';
            ctx.fillRect(x + 8, y + h * 0.75, 5, h * 0.25);
            ctx.fillRect(x + w - 13, y + h * 0.75, 5, h * 0.25);
            ctx.fillRect(x + w * 0.3, y + h * 0.75, 5, h * 0.25);
            ctx.fillRect(x + w * 0.6, y + h * 0.75, 5, h * 0.25);
            
            // Alpaca neck and head
            ctx.fillStyle = '#f5deb3';
            ctx.fillRect(x + w * 0.3, y, w * 0.4, h * 0.5);
            
            // Alpaca ears (m√°s grandes)
            ctx.fillStyle = '#daa520';
            ctx.fillRect(x + w * 0.25, y - 4, 4, 8);
            ctx.fillRect(x + w * 0.6, y - 4, 4, 8);
            
            // Ojos
            ctx.fillStyle = '#000';
            ctx.fillRect(x + w * 0.35, y + h * 0.1, 2, 2);
            ctx.fillRect(x + w * 0.55, y + h * 0.1, 2, 2);
        }
        
        function drawLlama(x: number, y: number, w: number, h: number) {
            if (!ctx) return;
            // Llama body (m√°s grande y visible)
            ctx.fillStyle = '#d4af37';
            ctx.fillRect(x + 8, y + h * 0.3, w - 16, h * 0.5);
            
            // Llama legs (4 patas visibles)
            ctx.fillStyle = '#8b7355';
            ctx.fillRect(x + 10, y + h * 0.7, 4, h * 0.3);
            ctx.fillRect(x + w - 14, y + h * 0.7, 4, h * 0.3);
            ctx.fillRect(x + w * 0.35, y + h * 0.7, 4, h * 0.3);
            ctx.fillRect(x + w * 0.55, y + h * 0.7, 4, h * 0.3);
            
            // Llama neck and head (m√°s prominente)
            ctx.fillStyle = '#daa520';
            ctx.fillRect(x + w * 0.25, y, w * 0.5, h * 0.5);
            
            // Llama ears (m√°s grandes)
            ctx.fillStyle = '#b8860b';
            ctx.fillRect(x + w * 0.2, y - 5, 5, 10);
            ctx.fillRect(x + w * 0.6, y - 5, 5, 10);
            
            // Ojos
            ctx.fillStyle = '#000';
            ctx.fillRect(x + w * 0.35, y + h * 0.1, 3, 3);
            ctx.fillRect(x + w * 0.55, y + h * 0.1, 3, 3);
        }
        
        function drawFox(x: number, y: number, w: number, h: number) {
            if (!ctx) return;
            // Fox body
            ctx.fillStyle = '#d2691e';
            ctx.fillRect(x + 1, y + h * 0.4, w - 2, h * 0.4);
            
            // Fox legs
            ctx.fillStyle = '#8b4513';
            ctx.fillRect(x, y + h * 0.7, 2, h * 0.3);
            ctx.fillRect(x + w - 2, y + h * 0.7, 2, h * 0.3);
            
            // Fox head
            ctx.fillStyle = '#ff6347';
            ctx.fillRect(x + w * 0.2, y, w * 0.6, h * 0.5);
            
            // Fox tail
            ctx.fillStyle = '#d2691e';
            ctx.fillRect(x + w * 0.7, y + h * 0.2, w * 0.3, h * 0.6);
        }
        
        function drawCat(x: number, y: number, w: number, h: number) {
            if (!ctx) return;
            // Cat body
            ctx.fillStyle = '#696969';
            ctx.fillRect(x + 2, y + h * 0.4, w - 4, h * 0.4);
            
            // Cat legs
            ctx.fillStyle = '#2f4f4f';
            ctx.fillRect(x + 1, y + h * 0.7, 2, h * 0.3);
            ctx.fillRect(x + w - 3, y + h * 0.7, 2, h * 0.3);
            
            // Cat head
            ctx.fillStyle = '#778899';
            ctx.fillRect(x + w * 0.25, y, w * 0.5, h * 0.4);
            
            // Cat ears
            ctx.fillStyle = '#2f4f4f';
            ctx.fillRect(x + w * 0.2, y - 2, 2, 4);
            ctx.fillRect(x + w * 0.6, y - 2, 2, 4);
        }
        
        function drawDeer(x: number, y: number, w: number, h: number) {
            if (!ctx) return;
            // Deer body
            ctx.fillStyle = '#8b4513';
            ctx.fillRect(x + 1, y + h * 0.3, w - 2, h * 0.5);
            
            // Deer legs
            ctx.fillStyle = '#654321';
            ctx.fillRect(x, y + h * 0.7, 2, h * 0.3);
            ctx.fillRect(x + w - 2, y + h * 0.7, 2, h * 0.3);
            
            // Deer head and neck
            ctx.fillStyle = '#a0522d';
            ctx.fillRect(x + w * 0.3, y, w * 0.4, h * 0.5);
            
            // Deer antlers
            ctx.fillStyle = '#8b7355';
            ctx.fillRect(x + w * 0.25, y - 5, 1, 8);
            ctx.fillRect(x + w * 0.55, y - 5, 1, 8);
            ctx.fillRect(x + w * 0.2, y - 3, 3, 1);
            ctx.fillRect(x + w * 0.5, y - 3, 3, 1);
        }
        
        function drawGenericAnimal(x: number, y: number, w: number, h: number) {
            if (!ctx) return;
            // Cuerpo principal
            ctx.fillStyle = '#8B4513';
            ctx.fillRect(x + 5, y + h * 0.3, w - 10, h * 0.5);
            
            // Patas
            ctx.fillStyle = '#654321';
            ctx.fillRect(x + 8, y + h * 0.75, 4, h * 0.25);
            ctx.fillRect(x + w - 12, y + h * 0.75, 4, h * 0.25);
            ctx.fillRect(x + w * 0.35, y + h * 0.75, 4, h * 0.25);
            ctx.fillRect(x + w * 0.55, y + h * 0.75, 4, h * 0.25);
            
            // Cabeza
            ctx.fillStyle = '#A0522D';
            ctx.fillRect(x + w * 0.3, y, w * 0.4, h * 0.4);
            
            // Ojos
            ctx.fillStyle = '#000';
            ctx.fillRect(x + w * 0.35, y + h * 0.1, 2, 2);
            ctx.fillRect(x + w * 0.55, y + h * 0.1, 2, 2);
        }

        // --- L√ìGICA DEL JUEGO ---
        function updateAndDrawRoad() {
            if (!canvas || !ctx) return;
            const roadWidth = canvas.width * 0.7;
            const roadMargin = (canvas.width - roadWidth) / 2;
            
            ctx.fillStyle = '#4a4a4a';
            ctx.fillRect(roadMargin + roadCurve, 0, roadWidth, canvas.height);

            // Aumento de velocidad progresivo cada 30% del juego
            const gameProgress = (111 - timeLeft) / 111;
            const speedIncrease = Math.floor(gameProgress / 0.3) * 0.05;
            roadSpeed = baseRoadSpeed * (1 + speedIncrease);
            
            const animalOnScreen = roadElements.find(el => el.type === 'animal');
            animalCrossingEvent = !!animalOnScreen;
            gameSpeedMultiplier = animalOnScreen ? 0.1 : 1; // M√°s lento durante cruce de animales
            
            if (animalOnScreen) {
                const article = ['huemul'].includes(animalOnScreen.animalName) ? 'un' : 'una';
                if (alertEl) {
                    alertEl.textContent = `¬°CUIDADO! ${article.toUpperCase()} ${animalOnScreen.animalName.toUpperCase()} CRUZANDO!`;
                    alertEl.classList.add('alert-visible');
                }
                console.log(`üö® Animal crossing alert: ${animalOnScreen.animalName} at x:${Math.round(animalOnScreen.x)}`);
            } else {
                alertEl?.classList.remove('alert-visible');
            }

            roadCurve = Math.sin(frameCount * 0.002) * (canvas.width / 8);
            
            roadElements.forEach((el, index) => {
                let currentSpeed = roadSpeed * gameSpeedMultiplier;
                
                if (el.type === 'obstacle') {
                    // Durante evento de animal, todos los camiones se detienen
                    if (animalCrossingEvent) {
                        currentSpeed = 0;
                    } else if (el.direction === 'opposite') {
                        // Tr√°fico contrario se mueve hacia abajo m√°s r√°pido
                        currentSpeed = roadSpeed * Math.abs(el.speedMultiplier);
                    } else {
                        // IA mejorada para tr√°fico mismo sentido
                        let effectiveSpeedMultiplier = el.speedMultiplier || 1;
                        let frontVehicle: any = null;
                        let backVehicle: any = null;
                        let canOvertake = true;
                        
                        // Definir posiciones de carriles
                        const centerX = canvas.width / 2;
                        const leftLaneX = centerX - roadWidth * 0.25;
                        const rightLaneX = centerX + roadWidth * 0.25;
                        
                        // Buscar veh√≠culos cercanos
                        for (let i = 0; i < roadElements.length; i++) {
                            if (i === index) continue;
                            const other = roadElements[i];
                            if (other.type === 'obstacle') {
                                const horizontalDistance = Math.abs(el.baseX - other.baseX);
                                const verticalDistance = (other.y || 0) - (el.y || 0);
                                
                                // Solo considerar veh√≠culos en el mismo carril o muy cerca
                                if (horizontalDistance < 60) {
                                    // Veh√≠culo adelante
                                    if (verticalDistance > 0 && verticalDistance < 150) {
                                        if (!frontVehicle || verticalDistance < ((frontVehicle.y || 0) - (el.y || 0))) {
                                            frontVehicle = other;
                                        }
                                    }
                                    // Veh√≠culo atr√°s
                                    else if (verticalDistance < 0 && verticalDistance > -100) {
                                        if (!backVehicle || Math.abs(verticalDistance) < Math.abs((backVehicle.y || 0) - (el.y || 0))) {
                                            backVehicle = other;
                                        }
                                    }
                                }
                                
                                // Verificar si puede adelantar (no hay tr√°fico contrario cerca)
                                if (other.direction === 'opposite' && Math.abs(verticalDistance) < 200) {
                                    canOvertake = false;
                                }
                                
                                // NUEVA L√ìGICA: Evitar colisiones entre camiones
                                if (horizontalDistance < 50 && Math.abs(verticalDistance) < 50) {
                                    // Camiones muy cerca - uno debe ceder
                                    if (el.direction === other.direction) {
                                        // Mismo sentido - el de atr√°s frena
                                        if (verticalDistance > 0) {
                                            effectiveSpeedMultiplier = 0.1; // Frenar fuerte
                                        }
                                    } else {
                                        // Sentido contrario - ambos se apartan
                                        const pushDirection = el.baseX > other.baseX ? 1 : -1;
                                        el.baseX += pushDirection * 2;
                                    }
                                }
                            }
                        }
                        
                        // Estados de IA
                        if (!el.aiState) el.aiState = 'normal';
                        if (!el.targetX) el.targetX = el.baseX;
                        
                        // L√≥gica de comportamiento mejorada
                        if (frontVehicle) {
                            const frontDistance = (frontVehicle.y || 0) - (el.y || 0);
                            const speedDifference = (el.speedMultiplier || 1) - (frontVehicle.speedMultiplier || 1);
                            
                            if (frontDistance < 50) {
                                // Muy cerca - frenar de emergencia
                                effectiveSpeedMultiplier = 0.1;
                                el.aiState = 'emergency_brake';
                            } else if (frontDistance < 150 && speedDifference > 0.1) {
                                // Veh√≠culo m√°s lento adelante - adelantar agresivamente
                                if (canOvertake && (el.aiState === 'normal' || el.aiState === 'following')) {
                                    // Mayor probabilidad de adelantar si hay mucha diferencia de velocidad
                                    const overtakeChance = Math.min(0.15, speedDifference * 0.3);
                                    if (Math.random() < overtakeChance) {
                                        el.aiState = 'overtaking';
                                        el.targetX = leftLaneX;
                                        el.overtakeStartTime = frameCount;
                                    }
                                }
                                if (el.aiState !== 'overtaking') {
                                    // Reducir velocidad pero mantener presi√≥n
                                    effectiveSpeedMultiplier = (frontVehicle.speedMultiplier || 1) * 0.95;
                                    el.aiState = 'following';
                                }
                            } else if (frontDistance < 100) {
                                // Distancia media - seguir con precauci√≥n
                                effectiveSpeedMultiplier = (frontVehicle.speedMultiplier || 1) * 0.98;
                                el.aiState = 'following';
                            }
                        } else {
                            // No hay veh√≠culo adelante
                            if (el.aiState === 'overtaking') {
                                // Completar adelantamiento m√°s r√°pido
                                if (Math.abs(el.baseX - leftLaneX) < 15) {
                                    el.targetX = rightLaneX;
                                    el.aiState = 'returning';
                                }
                            } else if (el.aiState === 'returning') {
                                if (Math.abs(el.baseX - rightLaneX) < 15) {
                                    el.aiState = 'normal';
                                }
                            } else {
                                el.aiState = 'normal';
                            }
                        }
                        
                        // Movimiento lateral m√°s r√°pido para adelantamientos
                        if (Math.abs(el.baseX - el.targetX) > 2) {
                            const moveDirection = el.targetX > el.baseX ? 1 : -1;
                            const moveSpeed = el.aiState === 'overtaking' || el.aiState === 'returning' ? 3 : 2;
                            el.baseX += moveDirection * moveSpeed;
                        }
                        
                        // Presi√≥n desde atr√°s
                        if (backVehicle && ((backVehicle.y || 0) - (el.y || 0)) > -60 && (backVehicle.speedMultiplier || 1) > (el.speedMultiplier || 1)) {
                            effectiveSpeedMultiplier = Math.min(1.0, effectiveSpeedMultiplier * 1.1);
                        }
                        
                        currentSpeed *= effectiveSpeedMultiplier;
                    }
                }
                
                if (el.hit) {
                    el.baseX += el.vx;
                    el.vx *= 0.95; 
                }
                
                el.y += currentSpeed;

                if (el.type === 'animal') {
                    el.x += el.vx;
                    // Los animales mantienen su posici√≥n Y fija (no se mueven con la carretera)
                    // el.y permanece constante para simular cruce horizontal
                }
                
                const elementX = (el.type === 'animal' ? el.x : el.baseX + roadCurve);
                
                // Debug para animales - mostrar posici√≥n cada segundo
                if (el.type === 'animal' && frameCount % 60 === 0) {
                    console.log(`ü¶ô Animal ${el.animalName} at x:${Math.round(el.x)}, y:${Math.round(el.y)}, vx:${el.vx}, visible: ${el.x > -100 && el.x < (canvas?.width || 400) + 100}`);
                }
                
                if (el.type === 'prize') drawTicket(el, elementX, el.y);
                else if (el.type === 'obstacle') drawEnemyTruck(el, elementX, el.y);
                else if (el.type === 'scenery' || el.type === 'guardrail') drawScenery(el, elementX, el.y);
                else if (el.type === 'animal') {
                    // Dibujar animal con efecto de brillo
                    ctx.save();
                    ctx.shadowColor = '#ffff00';
                    ctx.shadowBlur = 10;
                    drawAnimal(el, elementX, el.y);
                    ctx.restore();
                }
                else { ctx.fillStyle = el.color; ctx.fillRect(elementX, el.y, el.width, el.height); }

                const elementRect = { x: elementX, y: el.y, width: el.width, height: el.height };
                if (el.collidable && (checkCollision(truck, elementRect) || checkCollision(trailer, elementRect))) {
                    if (el.type === 'obstacle') {
                        playerHealth -= 40;
                        updateHealthBar();
                        shakeTime = 20;
                        el.collidable = false;
                        el.hit = true;
                        el.vx = (truck.x > elementX) ? 5 : -5; 
                        if (sfxSynth && sfxSynth.triggerAttackRelease) sfxSynth.triggerAttackRelease('A1', '0.4s');
                        if (playerHealth <= 0) {
                            gameOver("¬°Chocaste!");
                        }
                    } else if (el.type === 'animal') {
                        console.log(`üö® Collision with ${el.animalName}!`);
                        gameOver(`üò¢ ¬°Oh no! Atropellaste a ${el.animalName === 'huemul' ? 'un' : 'una'} ${el.animalName}. El chofer loco no lleg√≥ a tiempo a Poconchile...`);
                    } else if (el.type === 'prize' && !el.collected) {
                        collectPrize(el);
                        el.collected = true;
                    }
                }
            });

            roadElements = roadElements.filter(el => {
                if (el.type === 'animal') {
                    // Los animales se eliminan cuando salen de la pantalla horizontalmente
                    const stillOnScreen = el.x > -el.width - 50 && el.x < (canvas?.width || 400) + 50;
                    if (!stillOnScreen) {
                        console.log(`ü¶ô Animal ${el.animalName} removed at x:${el.x}`);
                    }
                    return stillOnScreen && !el.collected;
                } else {
                    // Otros elementos se eliminan cuando salen verticalmente
                    return el.y < (canvas?.height || 800) && !el.collected;
                }
            });
            generateRoadElements();
        }

        function generateRoadElements() {
            if (!canvas) return;
            const roadWidth = canvas.width * 0.7;
            const roadMargin = (canvas.width - roadWidth) / 2;
            const centerX = canvas.width / 2;
            const leftLaneX = centerX - roadWidth * 0.25;  // Carril izquierdo (tr√°fico contrario)
            const rightLaneX = centerX + roadWidth * 0.25; // Carril derecho (mismo sentido)

            // L√≠nea discontinua central
            if (frameCount % Math.round(12 / gameSpeedMultiplier) === 0) {
                roadElements.push({ type: 'line', baseX: centerX - 5, y: -40, width: 10, height: 20, color: 'rgba(255, 255, 255, 0.6)'});
            }
            
            // Guardarra√≠les
            if (frameCount % Math.round(40 / gameSpeedMultiplier) === 0) {
                roadElements.push({ type: 'guardrail', baseX: roadMargin - 10, y: -60, width: 10, height: 50, color: '#d3d3d3'});
                roadElements.push({ type: 'guardrail', baseX: roadMargin + roadWidth, y: -60, width: 10, height: 50, color: '#d3d3d3'});
            }
            
            // Escenograf√≠a
            if (frameCount % Math.round(30 / gameSpeedMultiplier) === 0) {
                const side = Math.random() < 0.5 ? 'left' : 'right';
                roadElements.push({
                    type: 'scenery',
                    baseX: side === 'left' ? 20 : (canvas?.width || 400) - 50,
                    y: -60, width: 30, height: Math.random() * 40 + 20,
                    color: side === 'left' ? '#8c7853' : '#a69061',
                    variant: Math.random() < 0.5 ? 'rock' : 'cactus'
                });
            }
            
            // Tr√°fico carril derecho (mismo sentido) - m√°s aleatorio
            const randomSpawnChance = Math.random();
            if (randomSpawnChance < 0.015) { // ~1.5% chance cada frame
                const randomSpeedMultiplier = 0.2 + Math.random() * 0.7; // 0.2 a 0.9
                
                // Verificar que no haya otro cami√≥n muy cerca
                const tooClose = roadElements.some(el => 
                    el.type === 'obstacle' && 
                    el.direction === 'same' && 
                    Math.abs(el.baseX - rightLaneX) < 40 && 
                    el.y > -200 && el.y < 100
                );
                
                if (!tooClose) {
                    roadElements.push({
                        type: 'obstacle',
                        baseX: rightLaneX,
                        y: -120, width: 45, height: 90,
                        color: '#2980b9',
                        speedMultiplier: randomSpeedMultiplier,
                        collidable: true,
                        hit: false,
                        vx: 0,
                        direction: 'same',
                        aiState: 'normal',
                        targetX: rightLaneX
                    });
                }
            }
            
            // Tr√°fico carril izquierdo (sentido contrario) - m√°s aleatorio
            const oppositeSpawnChance = Math.random();
            if (oppositeSpawnChance < 0.02) { // ~2% chance cada frame
                const randomOppositeSpeed = 1.0 + Math.random() * 1.0; // 1.0 a 2.0
                
                // Verificar que no haya otro cami√≥n muy cerca
                const tooClose = roadElements.some(el => 
                    el.type === 'obstacle' && 
                    el.direction === 'opposite' && 
                    Math.abs(el.baseX - leftLaneX) < 35 && 
                    el.y > -150 && el.y < 50
                );
                
                if (!tooClose) {
                    roadElements.push({
                        type: 'obstacle',
                        baseX: leftLaneX,
                        y: -120, width: 45, height: 90,
                        color: '#c0392b',
                        speedMultiplier: randomOppositeSpeed,
                        collidable: true,
                        hit: false,
                        vx: 0,
                        direction: 'opposite',
                        aiState: 'normal'
                    });
                }
            }
            
            // Premios
            if (frameCount > 100 && frameCount % 250 === 0) {
                 roadElements.push({ type: 'prize', baseX: centerX + (Math.random() * 100 - 50), y: -50, width: 40, height: 30, collidable: true });
            }
            
            // Animales aparecen solo a los 10, 40 y 60 segundos
            const gameTime = 111 - timeLeft;
            
            if (gameTime === 10 && !animalSpawned.at10) {
                spawnAnimal('llama', gameTime);
                animalSpawned.at10 = true;
            } else if (gameTime === 40 && !animalSpawned.at40) {
                spawnAnimal('huemul', gameTime);
                animalSpawned.at40 = true;
            } else if (gameTime === 60 && !animalSpawned.at60) {
                spawnAnimal('gato altipl√°nico', gameTime);
                animalSpawned.at60 = true;
            }
        }

        function collectPrize(prize: any) {
            if (sfxSynth && sfxSynth.triggerAttackRelease) {
                sfxSynth.triggerAttackRelease('C5', '0.1s');
                setTimeout(() => sfxSynth?.triggerAttackRelease && sfxSynth.triggerAttackRelease('E5', '0.1s'), 100);
                setTimeout(() => sfxSynth?.triggerAttackRelease && sfxSynth.triggerAttackRelease('G5', '0.1s'), 200);
            }
            
            score++;
            if (scoreEl) scoreEl.innerText = score.toString();
            
            // Animate score increase
            if (scoreEl) {
                scoreEl.style.transform = 'scale(1.2)';
                scoreEl.style.color = '#f1c40f';
                setTimeout(() => {
                    if (scoreEl) {
                        scoreEl.style.transform = 'scale(1)';
                        scoreEl.style.color = '#fff';
                    }
                }, 200);
            }
            
            if (playerPrizes.discount < 11) { 
                playerPrizes.discount = Math.min(11, playerPrizes.discount + 0.5); 
            }
            updatePrizesUI();
        }

        function updatePrizesUI() {
            if (!prizesEl) return;
            prizesEl.innerHTML = '';
            if (playerPrizes.discount > 0) {
                const li = document.createElement('li');
                li.className = 'prize-item';
                li.innerHTML = `üí∞ ${playerPrizes.discount.toFixed(1)}% Dcto`;
                prizesEl.appendChild(li);
            }
            if (prizesEl.children.length === 0) {
                prizesEl.innerHTML = '<li style="opacity: 0.6;">Ning√∫n premio a√∫n...</li>';
            }
        }

        function checkCollision(rect1, rect2) {
            return (rect1.x < rect2.x + rect2.width && rect1.x + rect1.width > rect2.x && rect1.y < rect2.y + rect2.height && rect1.y + rect1.height > rect2.y);
        }
        
        function spawnAnimal(animalName: string, gameTime: number) {
            if (!canvas) return;
            
            const startX = canvas.width + 50;
            const speed = -3;
            const crossingY = canvas.height * 0.35;
            
            console.log(`ü¶ô SPAWNING ${animalName} at ${gameTime}s - x:${startX}, y:${crossingY}`);
            
            roadElements.push({ 
                type: 'animal', 
                animalName: animalName, 
                x: startX, 
                y: crossingY,
                width: 80, 
                height: 80, 
                vx: speed,
                collidable: true,
                spawnTime: gameTime
            });
        }
        
        function resetGame() {
            modal?.classList.add('hidden');
            gameState = 'countdown';

            // Reset game variables
            score = 0; timeLeft = 111; frameCount = 0;
            playerHealth = 100;
            roadElements = [];
            playerPrizes = { discount: 0 };
            playerOffset = 0; roadCurve = 0;
            roadSpeed = baseRoadSpeed;
            animalCrossingEvent = false;
            animalSpawned = { at10: false, at40: false, at60: false };
            
            // Agregar l√≠neas discontinuas iniciales
            if (canvas) {
                const centerX = canvas.width / 2;
                for (let i = 0; i < 10; i++) {
                    roadElements.push({ 
                        type: 'line', 
                        baseX: centerX - 5, 
                        y: i * 60 - 200, 
                        width: 10, 
                        height: 20, 
                        color: 'rgba(255, 255, 255, 0.6)'
                    });
                }
            }
            if (scoreEl) scoreEl.innerText = score.toString();
            if (timerEl) timerEl.innerText = timeLeft.toString();
            updatePrizesUI();
            updateHealthBar();
            alertEl?.classList.remove('alert-visible');
            
            // Contador 3-2-1 con sonido sincronizado
            let countdown = 3;
            const countdownEl = document.createElement('div');
            countdownEl.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                font-size: 4rem; font-family: 'Press Start 2P'; color: #ffc107;
                text-shadow: 3px 3px 6px rgba(0,0,0,0.8); z-index: 200;
                text-align: center; vertical-align: middle;
            `;
            container?.appendChild(countdownEl);
            
            // Mostrar "3" inmediatamente
            countdownEl.textContent = countdown.toString();
            
            // Reproducir sonido de cuenta regresiva
            const countdownSound = new Audio('/music-game/321go.mp3');
            countdownSound.volume = 0.7;
            countdownSound.play().catch(err => console.warn('Countdown sound failed:', err));
            
            const countdownInterval = setInterval(() => {
                countdown--;
                if (countdown > 0) {
                    countdownEl.textContent = countdown.toString();
                } else if (countdown === 0) {
                    countdownEl.textContent = '¬°GO!';
                } else {
                    setTimeout(() => {
                        countdownEl.remove();
                        gameState = 'playing';
                        
                        // Reset stuck detection
                        lastFrameCount = 0;
                        stuckCheckTime = Date.now();
                        
                        // Iniciar m√∫sica despu√©s del countdown
                        startBackgroundMusic();
                        
                        if (typeof (window as any).Tone !== 'undefined') {
                            const Tone = (window as any).Tone;
                            Tone.start();
                        }
                        
                        // Iniciar timer del juego
                        if(gameInterval) clearInterval(gameInterval);
                        gameInterval = setInterval(() => {
                            timeLeft--;
                            if (timerEl) timerEl.innerText = timeLeft.toString();
                            
                            // Timer visual feedback
                            if (timerEl) {
                                if (timeLeft <= 10) {
                                    timerEl.style.color = '#ff4757';
                                    timerEl.style.animation = 'pulse 0.5s infinite';
                                } else if (timeLeft <= 30) {
                                    timerEl.style.color = '#ffc107';
                                } else {
                                    timerEl.style.color = '#fff';
                                    timerEl.style.animation = 'none';
                                }
                            }
                            
                            if (timeLeft <= 0) gameOver("¬°MISI√ìN CUMPLIDA! ¬°Llegaste a Poconchile a tiempo!");
                        }, 1000);
                        
                        requestAnimationFrame(gameLoop);
                    }, 500);
                    clearInterval(countdownInterval);
                }
            }, 1000);
        }

        function gameOver(message: string) {
            gameState = 'gameOver';
            
            clearInterval(gameInterval);
            stopBackgroundMusic();
            if((message.includes("Chocaste") || message.includes("averiado")) && sfxSynth && sfxSynth.triggerAttackRelease) sfxSynth.triggerAttackRelease('C2', '0.5s');
            
            // Verificar si es un crash para redirigir a la p√°gina de Game Over
            const isCrash = message.includes('Chocaste') || message.includes('averiado');
            
            if (isCrash) {
                // Reproducir sonido de crash
                const crashSound = new Audio('/music-game/crash.mp3');
                crashSound.volume = 0.7;
                crashSound.play().catch(err => console.warn('Crash sound failed:', err));
                
                // Mostrar modal temporal y redirigir despu√©s de 3 segundos
                modal?.classList.remove('hidden');
                if (modal) {
                    modal.innerHTML = `
                        <div style="text-align: center; color: #e74c3c;">
                            <h2 style="font-size: 2rem; margin-bottom: 20px;">‚ö° ¬°CRASH!</h2>
                            <p style="font-size: 1.2rem;">Redirigiendo...</p>
                        </div>
                    `;
                }
                
                // Redirigir despu√©s de 3 segundos
                setTimeout(() => {
                    const params = new URLSearchParams({
                        score: score.toString(),
                        discount: playerPrizes.discount.toFixed(1)
                    });
                    window.location.href = `/game/over?${params.toString()}`;
                }, 3000);
            } else {
                // Para casos de √©xito, mantener el modal actual
                modal?.classList.remove('hidden');
                const prizeText = playerPrizes.discount > 0 ? 
                    `üéÜ <span class="prize-success">¬°Conseguiste ${playerPrizes.discount.toFixed(1)}% de descuento!</span>` : 
                    'üò¢ <span class="no-prize">No conseguiste descuentos esta vez...</span>';
                
                const gameOverContent = `
                    <h2 class="animated-title">${message}</h2>
                    <div class="result-summary">
                        üé´ <strong>Tickets recogidos en la ruta:</strong> <span class="ticket-count">${score}</span><br>
                        ${prizeText}<br><br>
                        üéâ <span class="success-msg">¬°El chofer loco est√° agradecido!</span>
                    </div>
                `;
                
                if (modal) {
                    modal.innerHTML = `
                        <div style="text-align: center;">
                            ${gameOverContent}
                        </div>
                        <div class="button-group">
                            <button id="newStartButton" class="game-button restart-button">üîÑ Jugar de Nuevo</button>
                        </div>
                    `;
                    
                    const newStartButton = modal.querySelector('#newStartButton');
                    newStartButton?.addEventListener('click', () => {
                        resetGame();
                    });
                }
            }
        }
        
        function updateHealthBar() {
            if (!healthBar) return;
            playerHealth = Math.max(0, playerHealth);
            healthBar.style.width = `${playerHealth}%`;
            
            // Add visual feedback for low health
            if (playerHealth <= 30) {
                healthBar.classList.add('low');
            } else {
                healthBar.classList.remove('low');
            }
            
            // Update health bar gradient position
            const healthPercent = playerHealth / 100;
            const hue = healthPercent * 120; // 0 = red, 120 = green
            healthBar.style.background = `linear-gradient(90deg, 
                hsl(${Math.max(0, hue-30)}, 70%, 50%) 0%, 
                hsl(${hue}, 70%, 50%) 50%, 
                hsl(${Math.min(120, hue+30)}, 70%, 50%) 100%)`;
        }
        
        function handleScreenShake() {
            if (!canvas) return;
            if (shakeTime > 0) {
                const shakeX = (Math.random() - 0.5) * 15;
                const shakeY = (Math.random() - 0.5) * 15;
                canvas.style.transform = `translate(${shakeX}px, ${shakeY}px)`;
                shakeTime--;
            } else {
                canvas.style.transform = 'translate(0, 0)';
            }
        }

        function gameLoop(currentTime?: number) {
            if ((gameState !== 'playing' && gameState !== 'countdown') || !canvas || !ctx) return;
            
            // Durante countdown, solo dibujar elementos est√°ticos
            if (gameState === 'countdown') {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                updateAndDrawRoad();
                drawPlayer();
                requestAnimationFrame(gameLoop);
                return;
            }
            
            // Frame rate limiting
            if (currentTime && currentTime - lastFrameTime < frameInterval) {
                requestAnimationFrame(gameLoop);
                return;
            }
            if (currentTime) lastFrameTime = currentTime;
            
            // Game stuck detection - only during active gameplay
            const now = Date.now();
            if (gameState === 'playing' && now - stuckCheckTime > 5000) { // Check every 5 seconds during gameplay only
                if (frameCount === lastFrameCount) {
                    // Game is stuck, redirect to game over
                    console.warn('Game stuck detected, redirecting...');
                    const params = new URLSearchParams({
                        score: score.toString(),
                        discount: playerPrizes.discount.toFixed(1)
                    });
                    window.location.href = `/game/over?${params.toString()}`;
                    return;
                }
                lastFrameCount = frameCount;
                stuckCheckTime = now;
            }
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            frameCount++;
            
            handleScreenShake();
            updateAndDrawRoad();
            drawPlayer();

            const roadWidth = canvas.width * 0.7;
            const roadMargin = (canvas.width - roadWidth) / 2;
            const playerEdgeL = truck.x;
            const playerEdgeR = truck.x + truck.width;
            
            if (playerEdgeL < roadMargin || playerEdgeR > roadMargin + roadWidth) {
                playerHealth -= isMobile ? 2 / 60 : 3 / 60; 
                shakeTime = 5; 
                updateHealthBar();
                if (playerHealth <= 0) {
                    gameOver("üî• ¬°El foodtruck del chofer loco se ha averiado! No llegaste a Poconchile...");
                }
            }

            requestAnimationFrame(gameLoop);
        }

        // --- CONTROL SYSTEM ---
        function movePlayer(direction: string) {
            if (gameState !== 'playing' || !canvas) return;
            
            const currentTime = Date.now();
            if (currentTime - lastMoveTime < 16) return; // Throttle movement
            lastMoveTime = currentTime;
            
            const moveSpeed = isMobile ? 12 : 15;
            const roadWidth = canvas.width * 0.7;
            const maxOffset = roadWidth / 2;
            
            if (direction === 'left') {
                playerOffset -= moveSpeed;
            } else if (direction === 'right') {
                playerOffset += moveSpeed;
            }
            
            playerOffset = Math.max(-maxOffset, Math.min(maxOffset, playerOffset));
        }
        
        // Keyboard controls
        document.addEventListener('keydown', e => {
            if (e.key === 'ArrowLeft' || e.key.toLowerCase() === 'a') {
                movePlayer('left');
            } else if (e.key === 'ArrowRight' || e.key.toLowerCase() === 'd') {
                movePlayer('right');
            } else if (e.key === 'f' || e.key === 'F') {
                toggleFullscreen();
            }
        });
        
        // Touch controls - Optimized for mobile
        let leftTouchInterval: number;
        let rightTouchInterval: number;
        let isLeftPressed = false;
        let isRightPressed = false;
        
        // Left button touch events
        leftButton?.addEventListener('touchstart', (e) => {
            e.preventDefault();
            e.stopPropagation();
            if (isLeftPressed) return; // Prevent multiple touches
            
            isLeftPressed = true;
            leftButton.style.transform = 'scale(0.9)';
            leftButton.style.background = 'linear-gradient(145deg, rgba(255,255,255,0.5), rgba(255,255,255,0.3))';
            
            movePlayer('left');
            leftTouchInterval = setInterval(() => {
                if (isLeftPressed) movePlayer('left');
            }, 16); // 60fps for smooth movement
        }, { passive: false });
        
        leftButton?.addEventListener('touchend', (e) => {
            e.preventDefault();
            e.stopPropagation();
            isLeftPressed = false;
            clearInterval(leftTouchInterval);
            leftButton.style.transform = 'scale(1)';
            leftButton.style.background = 'linear-gradient(145deg, rgba(255,255,255,0.25), rgba(255,255,255,0.1))';
        }, { passive: false });
        
        leftButton?.addEventListener('touchcancel', (e) => {
            e.preventDefault();
            isLeftPressed = false;
            clearInterval(leftTouchInterval);
            leftButton.style.transform = 'scale(1)';
            leftButton.style.background = 'linear-gradient(145deg, rgba(255,255,255,0.25), rgba(255,255,255,0.1))';
        }, { passive: false });
        
        // Right button touch events
        rightButton?.addEventListener('touchstart', (e) => {
            e.preventDefault();
            e.stopPropagation();
            if (isRightPressed) return; // Prevent multiple touches
            
            isRightPressed = true;
            rightButton.style.transform = 'scale(0.9)';
            rightButton.style.background = 'linear-gradient(145deg, rgba(255,255,255,0.5), rgba(255,255,255,0.3))';
            
            movePlayer('right');
            rightTouchInterval = setInterval(() => {
                if (isRightPressed) movePlayer('right');
            }, 16); // 60fps for smooth movement
        }, { passive: false });
        
        rightButton?.addEventListener('touchend', (e) => {
            e.preventDefault();
            e.stopPropagation();
            isRightPressed = false;
            clearInterval(rightTouchInterval);
            rightButton.style.transform = 'scale(1)';
            rightButton.style.background = 'linear-gradient(145deg, rgba(255,255,255,0.25), rgba(255,255,255,0.1))';
        }, { passive: false });
        
        rightButton?.addEventListener('touchcancel', (e) => {
            e.preventDefault();
            isRightPressed = false;
            clearInterval(rightTouchInterval);
            rightButton.style.transform = 'scale(1)';
            rightButton.style.background = 'linear-gradient(145deg, rgba(255,255,255,0.25), rgba(255,255,255,0.1))';
        }, { passive: false });
        
        // Mouse events as fallback for desktop testing
        leftButton?.addEventListener('mousedown', (e) => {
            e.preventDefault();
            if (!isMobile) movePlayer('left');
        });
        
        rightButton?.addEventListener('mousedown', (e) => {
            e.preventDefault();
            if (!isMobile) movePlayer('right');
        });
        
        // Prevent context menu on touch buttons
        leftButton?.addEventListener('contextmenu', (e) => e.preventDefault());
        rightButton?.addEventListener('contextmenu', (e) => e.preventDefault());
        
        // --- FULLSCREEN FUNCTIONALITY ---
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().then(() => {
                    document.body.classList.add('fullscreen');
                    isFullscreen = true;
                    resizeCanvas();
                }).catch(err => {
                    console.warn('Fullscreen failed:', err);
                });
            } else {
                document.exitFullscreen().then(() => {
                    document.body.classList.remove('fullscreen');
                    isFullscreen = false;
                    resizeCanvas();
                });
            }
        }
        
        // --- EVENT LISTENERS ---


        
        startButton?.addEventListener('click', () => {
            resetGame();
        });
        

        

        
        // Prevent context menu and improve touch handling
        canvas?.addEventListener('contextmenu', e => e.preventDefault());
        container?.addEventListener('contextmenu', e => e.preventDefault());
        
        // Prevent zoom on double tap for mobile
        document.addEventListener('touchstart', (e) => {
            if (e.touches.length > 1) {
                e.preventDefault();
            }
        }, { passive: false });
        
        // Prevent default touch behaviors that might interfere
        document.addEventListener('touchmove', (e) => {
            if (e.target === leftButton || e.target === rightButton) {
                e.preventDefault();
            }
        }, { passive: false });
        
        // Handle orientation change
        window.addEventListener('orientationchange', () => {
            setTimeout(resizeCanvas, 100);
        });
        
        // Initialize UI
        updatePrizesUI();
        updateHealthBar();
        
        // Add pulse animation for timer
        const style = document.createElement('style');
        style.textContent = `
            @keyframes pulse {
                0%, 100% { transform: scale(1); }
                50% { transform: scale(1.1); }
            }
        `;
        document.head.appendChild(style);
        
        // Preload audio on first user interaction
        document.addEventListener('click', () => {
            if (typeof (window as any).Tone !== 'undefined') {
                const Tone = (window as any).Tone;
                if (Tone.context.state !== 'running') {
                    Tone.start();
                }
            }
        }, { once: true });
        
        // Add keyboard shortcut info
        document.addEventListener('keydown', (e) => {
            if (e.key === '?' || e.key === 'h') {
                const helpModal = document.createElement('div');
                helpModal.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0,0,0,0.9); display: flex; align-items: center;
                    justify-content: center; z-index: 1000; font-family: 'Press Start 2P';
                    color: white; font-size: 0.8rem; line-height: 1.6;
                `;
                helpModal.innerHTML = `
                    <div style="background: rgba(0,0,0,0.8); padding: 30px; border-radius: 15px; text-align: center; max-width: 400px;">
                        <h3 style="color: #ffc107; margin-bottom: 20px;">üéÆ Controles del Juego</h3>
                        <p>‚Üê ‚Üí o A/D: Mover el foodtruck</p>
                        <p>?: Mostrar esta ayuda</p>
                        <br>
                        <p style="color: #2ecc71;">üéØ Objetivo: Sobrevive 111 segundos</p>
                        <p style="color: #e74c3c;">‚ö†Ô∏è Evita chocar con otros veh√≠culos</p>
                        <p style="color: #f1c40f;">üé´ Recoge tickets para ganar premios</p>
                        <br>
                        <button onclick="this.parentElement.parentElement.remove()" 
                                style="background: #2ecc71; color: white; border: none; padding: 10px 20px; 
                                       border-radius: 5px; font-family: 'Press Start 2P'; cursor: pointer;">
                            ‚úì Entendido
                        </button>
                    </div>
                `;
                document.body.appendChild(helpModal);
            }
        });
        
        // Add visual feedback for button presses
        [startButton].forEach(button => {
            if (!button) return;
            button.addEventListener('mousedown', () => {
                if (button) button.style.transform = 'translateY(2px) scale(0.98)';
            });
            
            button.addEventListener('mouseup', () => {
                if (button) button.style.transform = 'translateY(-3px) scale(1)';
            });
            
            button.addEventListener('mouseleave', () => {
                if (button) button.style.transform = 'translateY(0) scale(1)';
            });
        });
        
        // Handle orientation change with improved detection
        window.addEventListener('orientationchange', () => {
            setTimeout(() => {
                resizeCanvas();
                isMobile = window.innerWidth <= 768;
                truck.width = isMobile ? 40 : 50;
                truck.height = isMobile ? 60 : 70;
                trailer.width = isMobile ? 45 : 55;
                trailer.height = isMobile ? 90 : 110;
            }, 100);
        });
        
        // Easter egg - Konami code
        let konamiCode: number[] = [];
        const konami = [38, 38, 40, 40, 37, 39, 37, 39, 66, 65];
        
        document.addEventListener('keydown', (e) => {
            konamiCode.push(e.keyCode);
            if (konamiCode.length > konami.length) {
                konamiCode.shift();
            }
            
            if (konamiCode.length === konami.length && 
                konamiCode.every((code, i) => code === konami[i])) {
                playerHealth = 200;
                roadSpeed *= 0.5;
                updateHealthBar();
                
                const cheatMsg = document.createElement('div');
                cheatMsg.style.cssText = `
                    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                    background: linear-gradient(45deg, #ff6b35, #f7931e); color: white;
                    padding: 20px; border-radius: 10px; font-family: 'Press Start 2P';
                    font-size: 0.8rem; z-index: 1000; text-align: center;
                    box-shadow: 0 0 30px rgba(255, 107, 53, 0.5);
                `;
                cheatMsg.innerHTML = 'üéÜ ¬°MODO CHEAT ACTIVADO!<br>üí™ Salud extra y velocidad reducida';
                document.body.appendChild(cheatMsg);
                
                setTimeout(() => cheatMsg.remove(), 3000);
                konamiCode = [];
            }
        });
    </script>
    
    <!-- Service Worker for PWA -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => console.log('SW registered'))
                    .catch(error => console.log('SW registration failed'));
            });
        }
    </script>
</body>
</html>